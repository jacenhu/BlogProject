# [SOSP03] GFS 论文阅读

  《The Google File System》发表于2003年。

## 关键词

故障容错，可扩展性。数据存储，集群存储

## 1 介绍

第一、组件故障是常态而不是异常。

> 故障原因：程序bug、OS bug、人为失误、磁盘、内存、网络、供电设备等。

第二、文件较大。

第三、大部分文件的更新是通过追加新数据而不是覆盖已有数据。

第四、共同设计应用程序和文件系统。

## 2 设计概述

### 2.1 假设

* 系统由需要经常故障的廉价组件构成。
* 系统由一定数量的大文件组成。
* 负载主要由两种读组成：大的流式读和小的随机读。
* 负载有很多大的追加写。一旦写完成，文件将很少被修改。
* 系统必须为多客户端并发操作文件提供良好语义。
* 高可持续的带宽比低时延更重要。

### 2.2 接口

文件在目录中以层次组织，并且以路径名标识。

支持通常的操作：create、delete、open、close、read、write。

此外支持：snapshot、record append。

### 2.3 架构

文件被拆分成定长的chunk。每个chunk由一个不可变且全局唯一的64位标识。每个chunk在多个chunk server复制，默认是3副本。

master维护所有的文件系统元数据。包括name space、访问控制信息、从文件到块的映射以及块的当前位置。同时控制系统范围的活动，如：chunk 租约管理，孤立chunk的垃圾回收，chunk server间的chunk 迁移。master通过与每个chunk server周期性的发送心跳消息进行通信来给它指令和收集它的状态。

链接到每个应用程序的GFS客户端实现了文件系统API，同时与master、chunk server通信，代表应用程序进行数据的读写。客户端与master交互获取元数据，但所有的数据通信都是到chunk server。

![GFS 架构](./res/GFS_Architecture.png)

### 2.4 单主

客户端读写数据不需要经过master。

客户端需要询问master它需要和哪个chunk server通信。

客户端将这种信息缓存下来一段时间，然后在后续操作直接与chunk server交互。

### 2.5 块大小

chunk size是关键设计参数之一，GFS是64MB。

### 2.6 元数据

master主要存储三种类型的元数据：文件和chunk namespace、文件到chunk的映射、每个chunk 副本的位置。

#### 2.6.1 内存中的数据结构

元数据存储在内存中，master的操作将非常快。

#### 2.6.2 块的地址

master不会永久记录chunk server与chunk副本间的关系。master在启动时会轮询chunk server获取此类信息。

####  2.6.3 操作日志

操作日志包含关键的元数据变化历史记录。

master通过回放操作日志来恢复文件系统状态。

为减少启动时间，必须使得日志尽量小。当日志超过一定大小的时候，master就会进行check point。check point使用一个压缩的类B树结构。

#### 2.7 一致性模型

#### 2.7.1 GFS的保证

文件name space变化是原子性的。

#### 2.7.2 应用程序的影响



## 3 系统交互

### 3.1 租约和变化顺序

### 3.2 数据流

### 3.3 原子记录追加

### 3.4 快照

## 4 主的操作

### 4.1 命名空间管理与锁定

### 4.2 副本位置

### 4.3 创建、再复制、再平衡

### 4.4 垃圾回收

#### 4.4.1 机制

#### 4.4.2 讨论

### 4.5 旧副本检测

## 5 故障容错和诊断

### 5.1 高可用性

### 5.2 数据完整性

### 5.3 诊断工具

## 6 测量

### 6.1 微型基准测试

### 6.2 真实的集群

### 6.3 负载分解

## 7 经验

## 8 相关的工作

## 9 结论